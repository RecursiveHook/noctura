{
  admin off
}

:80 {
  respond "Noctura - HTTP endpoint. Use HTTPS for secure access." 200
}

:443 {
  tls internal

  encode gzip zstd

  handle /couchdb/* {
    uri strip_prefix /couchdb
    reverse_proxy couchdb:5984 {
      header_up Host {upstream_hostport}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
    }
  }

  handle /obsidian/* {
    uri strip_prefix /obsidian
    reverse_proxy obsidian:8080 {
      header_up Host {upstream_hostport}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up Upgrade {http.request.header.Upgrade}
      header_up Connection {http.request.header.Connection}
    }
  }

  handle /vnc/* {
    uri strip_prefix /vnc
    reverse_proxy obsidian:8080 {
      header_up Host {upstream_hostport}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-For {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up Upgrade {http.request.header.Upgrade}
      header_up Connection {http.request.header.Connection}
    }
  }

  handle {
    respond "Noctura - Secure Obsidian Sync" 200
  }
}
