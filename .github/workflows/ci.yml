name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  COUCHDB_PASSWORD: test_password_123456789
  VNC_PASSWORD: test_vnc_password
  ENCRYPTION_KEY: test_encryption_key_12345678

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  shellcheck:
    name: Shellcheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@2.0.0
        with:
          scandir: './scripts'
          severity: warning

  docker-compose-validation:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate docker-compose.yml
        run: docker compose config

  build-test:
    name: Build Platform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Create .env file
        run: |
          cp .env.example .env
          sed -i "s/COUCHDB_PASSWORD=CHANGE_ME/COUCHDB_PASSWORD=${COUCHDB_PASSWORD}/" .env
          sed -i "s/VNC_PASSWORD=CHANGE_ME/VNC_PASSWORD=${VNC_PASSWORD}/" .env
          sed -i "s/ENCRYPTION_KEY=CHANGE_ME/ENCRYPTION_KEY=${ENCRYPTION_KEY}/" .env
      
      - name: Pull Docker images
        run: docker compose pull
      
      - name: Build and start services
        run: docker compose up -d --build
      
      - name: Wait for services to be healthy
        run: |
          echo "⏳ Waiting for all services to pass healthchecks..."
          docker compose up --wait --wait-timeout 90
          echo "✅ All services are healthy!"
      
      - name: Initialize CouchDB system databases
        run: |
          echo "📋 Creating CouchDB system databases..."
          if ! curl -sf -k -u "admin:${COUCHDB_PASSWORD}" -X PUT https://localhost/couchdb/_users; then
            echo "⚠️  _users database may already exist or failed to create"
          fi
          if ! curl -sf -k -u "admin:${COUCHDB_PASSWORD}" -X PUT https://localhost/couchdb/_replicator; then
            echo "⚠️  _replicator database may already exist or failed to create"
          fi
          echo "✅ System databases initialization complete"
      
      - name: Verify CouchDB version
        run: |
          VERSION=$(curl -sk https://localhost/couchdb/ | grep -o '"version":"[^"]*"' | cut -d'"' -f4)
          echo "CouchDB version: $VERSION"
          if [ -z "$VERSION" ]; then
            echo "❌ Failed to get CouchDB version"
            exit 1
          fi
      
      - name: Test authentication
        run: |
          if curl -sf -k -u "admin:${COUCHDB_PASSWORD}" https://localhost/couchdb/_all_dbs > /dev/null 2>&1; then
            echo "✅ Authentication successful"
          else
            echo "❌ Authentication failed"
            exit 1
          fi
      
      - name: Initialize database
        run: ./scripts/init-db.sh obsidian
      
      - name: Verify database created
        run: |
          if curl -sf -k -u "admin:${COUCHDB_PASSWORD}" https://localhost/couchdb/obsidian > /dev/null 2>&1; then
            echo "✅ Database 'obsidian' created successfully"
          else
            echo "❌ Database 'obsidian' not found"
            exit 1
          fi
      
      - name: Show container status
        if: always()
        run: docker compose ps
      
      - name: Show service logs
        if: always()
        run: |
          echo "=== gocryptfs logs ==="
          docker compose logs gocryptfs
          echo "=== CouchDB logs ==="
          docker compose logs couchdb
      
      - name: Cleanup
        if: always()
        run: docker compose down -v

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cp .env.example .env
          sed -i "s/COUCHDB_PASSWORD=CHANGE_ME/COUCHDB_PASSWORD=${COUCHDB_PASSWORD}/" .env
          sed -i "s/VNC_PASSWORD=CHANGE_ME/VNC_PASSWORD=${VNC_PASSWORD}/" .env
          sed -i "s/ENCRYPTION_KEY=CHANGE_ME/ENCRYPTION_KEY=${ENCRYPTION_KEY}/" .env
      
      - name: Start services
        run: docker compose up -d
      
      - name: Wait for services to be healthy
        run: |
          echo "⏳ Waiting for all services to pass healthchecks..."
          docker compose up --wait --wait-timeout 90
          echo "✅ All services are healthy!"
      
      - name: Initialize CouchDB system databases
        run: |
          echo "Creating CouchDB system databases..."
          if ! curl -sf -k -u "admin:${COUCHDB_PASSWORD}" -X PUT https://localhost/couchdb/_users; then
            echo "⚠️  _users database may already exist or failed to create"
          fi
          if ! curl -sf -k -u "admin:${COUCHDB_PASSWORD}" -X PUT https://localhost/couchdb/_replicator; then
            echo "⚠️  _replicator database may already exist or failed to create"
          fi
          echo "System databases initialization complete"
      
      - name: Run health checks
        run: ./scripts/health-check.sh
      
      - name: Run integration tests
        run: ./scripts/test.sh
      
      - name: Generate test summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Categories:**" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Encryption (key, permissions, gocryptfs)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ TLS/HTTPS (Caddy, certificates, redirects)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ CouchDB (auth, CRUD operations, reverse proxy)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Obsidian (container, web interface)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Scripts (backup, restore, health check)" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Configuration (docker-compose, file permissions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests:** 20" >> $GITHUB_STEP_SUMMARY
      
      - name: Show service logs
        if: always()
        run: |
          echo "=== gocryptfs logs ==="
          docker compose logs gocryptfs
          echo "=== CouchDB logs ==="
          docker compose logs couchdb
      
      - name: Stop services
        if: always()
        run: docker compose down -v

  markdown-lint:
    name: Markdown Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Lint Markdown files
        uses: avto-dev/markdown-lint@v1
        with:
          args: '**/*.md'
          ignore: 'node_modules'
